```{r}
#| label: sec7func
#| cache: true
#| cache.comments: false

rsdatatmp <- rsdata %>%
  filter(shf_indexyear_cat == "2021-2023")

sec7func <- function(data = rsdatatmp, colvar, colname) {
  tab <- data %>%
    filter(!is.na(sos_lm_gdmttype) & !is.na(!!sym(colvar))) %>%
    group_by(!!sym(colvar)) %>%
    count(sos_lm_gdmttype, .drop = F) %>%
    mutate(np = paste0(n, " (", fn(n / sum(n) * 100, 1), ")")) %>%
    ungroup() %>%
    mutate(
      np = case_when(
        n < 10 ~ "<10",
        TRUE ~ np
      )
    ) %>%
    select(sos_lm_gdmttype, np, !!sym(colvar)) %>%
    pivot_wider(values_from = np, names_from = c(!!sym(colvar))) %>%
    rename(Medication = sos_lm_gdmttype) %>%
    arrange(Medication)

  taball <- data %>%
    filter(!is.na(sos_lm_gdmttype) & !is.na(!!sym(colvar))) %>%
    count(!!sym(colvar)) %>%
    mutate(np = paste0(n, " (", fn(n / sum(n) * 100, 1), ")")) %>%
    ungroup() %>%
    mutate(
      sos_lm_gdmttype = "N",
      np = case_when(
        n < 10 ~ "<10",
        TRUE ~ np
      )
    ) %>%
    select(sos_lm_gdmttype, np, !!sym(colvar)) %>%
    pivot_wider(values_from = np, names_from = c(!!sym(colvar))) %>%
    rename(Medication = sos_lm_gdmttype)

  tab <- bind_rows(taball, tab)

  # excel
  if (output) {
    make_one_xlsxsheet(tab)
  }

  colnames(tab) <- sanitize_text(colnames(tab))
  colnames(tab) <- str_replace_all(colnames(tab), fixed("$>$="), "$\\geq$")
  colnames(tab) <- str_replace_all(colnames(tab), fixed("$<$="), "$\\leq$")

  nlevs <- nlevels(data %>% pull(!!sym(colvar)))

  header <- c(1, nlevs)
  names(header) <- c(" ", colname)

  default_kable(tab,
    escape = FALSE,
    scale_down = T,
    font_size = 7
  ) %>%
    footnote(
      footnote_order = c("general", "symbol", "alphabet"),
      general_title = "",
      general = c(
        "Presented with n (%)."
      )
    ) %>%
    add_header_above(header = header) %>%
    row_spec(1, hline_after = T)
}
```

```{r}
#| label: tbl-sec7-sysbp
#| cache: true
#| cache.comments: false
#| dependson: sec7func
#| tbl-cap: "Secondary objective 7 by systolic blood pressure (2021-2023)"
#| tbl-pos: "H"

sec7func(colvar = "shf_bpsys_cateli", colname = "Systolic blood pressure (mmHg)")
```

```{r}
#| label: tbl-sec7-heartrate
#| cache: true
#| cache.comments: false
#| dependson: sec7func
#| tbl-cap: "Secondary objective 7 by heart rate (2021-2023)"
#| tbl-pos: "H"

sec7func(colvar = "shf_heartrate_cateli", colname = "Heart rate (beats/min)")
```

```{r}
#| label: tbl-sec7-egfr
#| cache: true
#| cache.comments: false
#| dependson: sec7func
#| tbl-cap: "Secondary objective 7 by eGFR (2021-2023)"
#| tbl-pos: "H"

sec7func(colvar = "shf_gfrckdepi_cateli", colname = "eGFR (mL/min/1.73 m2)")
```

```{r}
#| label: tbl-sec7-potassium
#| cache: true
#| cache.comments: false
#| dependson: sec7func
#| tbl-cap: "Secondary objective 7 by potassium (2021-2023)"
#| tbl-pos: "H"

sec7func(colvar = "shf_potassium_cateli", colname = "Potassium (mmol/L)")
```

```{r}
#| label: tbl-sec7-dmtype1
#| cache: true
#| cache.comments: false
#| dependson: sec7func
#| tbl-cap: "Secondary objective 7 by diabetes type I (2021-2023)"
#| tbl-pos: "H"

sec7func(colvar = "shf_diabetestypeeli", colname = "Diabetes type I")
```

```{r}
#| label: tbl-sec7-all
#| cache: true
#| cache.comments: false
#| dependson: sec7func
#| tbl-cap: "Secondary objective 7 by all eligibilty variables (2021-2023)"
#| tbl-pos: "H"

sec7func(colvar = "elall", colname = "Overall eligibilty")
```
